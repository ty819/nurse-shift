以下は「**看護師シフト自動割当Webアプリ（ノーDB・PDF出力版）**」の要件定義と目的です。
まずは**ファイル駆動・無保存（No-DB）**で実装し、将来拡張でDB導入可能な前提にします。

# 1. 目的（Purpose）

* 看護師個々の勤務条件（夜勤回数、勤務可能日、週当たり上限、土日祝制限、役割可否 等）を厳守しつつ、**日勤・夜勤の必要人数を充足**する**月間シフト**を**自動生成**する。
* 生成結果は**PDF出力**で配布可能。必要に応じて手動微修正→再チェックができる。
* **公平性**（夜勤・週末・連勤の偏り）と**安全性**（休息・リーダー配置）をバランスさせた「説明可能な割当」を提供する。

# 2. スコープ（Scope）

* 対象：病棟Ns 20〜30名規模／月間シフト（1か月）
* シフト型：早・日・遅・夜・休（※ノーDB版は日/遅/夜/休を中心に開始、早は将来拡張可）
* 出力：PDF（シフト表＋サマリ）、オプションでCSV
* 入力：CSV/JSON（Ns属性・月次ルール・各日必要人数・祝日定義）
* 非対象（初期）：勤怠実績取り込み、給与計算、モバイル個別アプリ、承認ワークフロー、通知、監査ログ（＝将来DB導入時に対応）

# 3. ステークホルダー / 権限

* 管理者/師長：条件ファイル投入、最適化実行、手動微修正、PDF出力
* 一般Ns：閲覧のみ（初期は提供外、PDF配布想定）

# 4. 前提・定義

* **ノーDB**：状態保存なし。毎回ファイル投入→最適化→ダウンロード。
* **最適化エンジン**：サーバ側でCP-SAT（OR-Tools）を実行。解が出ない場合は制約緩和案（警告）を提示。
* **休息規則**：夜勤翌日は日勤不可（明け休の扱いは要件通りに厳守）。
* **公休**：通常9回/月、夜勤専従のみ10回/月。

# 5. 主要機能要件（Functional Requirements）

## 5.1 入力

* Ns台帳（CSV）：`id, name, team(A/B/救急), role(管理者/一般), leader_ok(bool), shift_capability(日/遅/夜), contract(note), availability_rule(...)`
* 月間ルール（JSON）

  * カレンダー：対象年月、祝日一覧
  * 需要：各日 `day_required_min/max`、`night_required=3`、`weekday late=1`（平日のみ遅番1名）
  * リーダー要件：土日祝は {2,3,4,5,6,7,15,16,17,18} のいずれかを**日勤**で1名以上配置
  * 組合せ禁止：夜勤の「7 と 26」は同一日不可
  * 夜勤構成：**A/B/救急の3名構成**（内訳ルールを満たす）
* 個別条件（今回の指定を反映）

  * **Aチーム**

    * 1,2：管理者／**日勤のみ**／土日祝基本休
    * 4,5,6,7,8,9,11：**夜勤4–6回/月**
    * 10：日勤のみ
    * 12：新人 **夜勤2回/月**（※“通常＋1人員”扱いの特別枠）
    * 13：**週2回**／土日祝 **月3回まで**
    * 14：**9:00–17:00** パート／土日祝NG
  * **Bチーム**

    * 15,17,18,19,21,22：**夜勤4–6回/月**
    * 20：**夜勤2回/月**／基本土日休み
    * 23：**週2回**／土日祝NG
    * 24：**9:00–16:30**／土日祝NG
    * 25：**週2回 9:00–13:00**
  * **救急チーム**

    * 3：**夜勤4回/月**（A/B応援可）
    * 16：**夜勤4–6回/月**（B応援可）
    * 26：**夜勤専従9回/月**、**公休10日＋有休**
    * 27：**夜勤4–6回/月**、**土日祝は日勤外す**
    * 28,29：**夜勤2回/月**、**日勤なし**
    * 30：**土日夜勤2回/月**、**日勤なし**
    * 32：**土日勤バイト2回/月**
    * 33：**日勤バイト2回/月**
* 日別必要人数

  * **平日：日勤 11–14 名**、**遅番 1 名（平日のみ）**
  * **土曜・祝日：日勤 8 名**
  * **日曜：日勤 7 名**
  * **夜勤：3 名**（A/B/救急の3名で構成）

## 5.2 制約（ハード＝必須 / ソフト＝ペナルティ最小）

* **ハード制約**

  * 各日・各枠の必要人数充足（上記人数・遅番1）
  * 夜勤構成（A/B/救急の混成3名）
  * 夜勤翌日の日勤不可
  * 個人の**夜勤回数範囲**・**勤務可能帯**（日勤のみ等）・**土日祝制限**・**週回数上限**
  * **一人一枠**（同一日に複数シフト不可）
  * **組合せ禁止**：夜勤の「7 と 26」同日不可
  * **リーダー要件**：土日祝に指定リストから**日勤**を1名以上
  * **公休回数**：通常9回、夜勤専従10回
* **ソフト制約（目的関数で最小化）**

  * 夜勤/週末の偏り（個人間分散）
  * 連続夜勤や連勤の抑制（規定内での小さめ誘導）
  * 希望休・希望帯の尊重（将来）
  * “新人12の＋1人員”：夜勤日の加点（充足の質スコア）
  * 可能なら前回確定版との差分最小（将来）

## 5.3 出力

* **PDF**（月間シフト表）

  * 行：Ns、列：日付、セル：早/日/遅/夜/休
  * サマリ：個人別 夜勤回数／土日祝勤務回数／公休回数／警告一覧
* **CSV**（任意）：`nurse_id,date,shift`
* **警告**：満たせなかった制約・過不足・緩和候補（例：日勤最小を一部日で-1に）

## 5.4 操作フロー

1. ルール/台帳ファイルアップロード
2. 最適化実行（サーバでCP-SAT）
3. 結果プレビュー（充足率・警告）
4. （任意）手動差し替え → 制約チェック
5. PDFダウンロード

# 6. 非機能要件（NFR）

* **性能**：30名×31日×（日/遅/夜/休）規模で初回解を実用時間内に返す（目安：数十秒程度）
* **可用性**：サーバ冗長化は将来。初期は単一リージョン運用
* **セキュリティ**：アップロードファイルは揮発（保存しない）、TLS、サイズ制限
* **監査**：初期はなし（将来DB導入時に追加）
* **アクセシビリティ**：主要操作はキーボード操作可、PDFは高コントラスト配慮

# 7. アーキテクチャ（最小構成）

* **フロント**：Next.js + TypeScript + Tailwind（DnDは任意）
* **最適化API**：FastAPI + OR-Tools（CP-SAT）
* **PDF**：Puppeteer/Playwrightでサーバサイド印刷
* **デプロイ**：Vercel（フロント）／Render or Cloud Run（API）
* **データ保管**：なし（インメモリ）— 将来Supabase導入前提で拡張容易に

# 8. データモデル（ファイル仕様：例）

* `nurses.csv`

  * `id,name,team(A|B|ER),leader_ok(true|false),day_ok,late_ok,night_ok,week_max_days,weekend_cap,notes`
* `rules.json`

  * `year,month,holidays:[YYYY-MM-DD,...]`
  * `demand:{ "YYYY-MM-DD": { "day_min":11,"day_max":14,"late":1,"night":3 }, ... }`
  * `leader_requirement:{ "weekend_holiday": ["2","3","4","5","6","7","15","16","17","18"] }`
  * `forbidden_pairs:{ "night":[["7","26"]] }`
  * `person_rules:{ "1":{"only_day":true,"holiday_off":true}, "4":{"night_min":4,"night_max":6}, ... }`

# 9. 目的関数（最適化方針）

* **ハード制約は必ず満たす**前提で、以下のペナルティ総和を最小化：

  * 夜勤・週末・連勤の偏り（分散・超過）
  * 日勤最小/最大からの逸脱
  * 個別上限/下限からの逸脱
  * 新人12の夜勤日「質スコア」最大化（負ペナルティで実装）

# 10. 例外処理 / フォールバック

* **不可解**：制約が厳しすぎて実行不能→

  * 満たせない制約一覧を提示
  * 自動緩和案（例：特定日の日勤最小−1、特定Nsの週2→週3一時許可 等）を候補表示

# 11. テスト計画

* **ユニット**：夜勤翌日日勤不可、組合せ禁止、土日祝リーダー要件、各人回数制約
* **統合**：30名ダミーデータで月間充足・計算時間・PDF整形
* **リグレッション**：将来DB導入時にI/O互換性を検証

# 12. リスク / 将来拡張

* リスク：制約過多で不可解、計算時間増大、入力データ不備
* 拡張：DB導入（承認/履歴/通知/多病棟）、Googleカレンダー連携、モバイル閲覧、スキルミックス最適化、勤務希望申請UI

# 13. 受け入れ基準（Acceptance Criteria）

* 指定月について、上記**人数要件**・**個別条件**・**組合せ禁止**・**リーダー要件**・**公休**を**違反0**で満たす解を出力（不可解時は緩和案を提示）
* **PDF**にて月間表とサマリ（夜勤回数/土日祝回数/公休/警告）が正しく出力
* 「夜勤翌日日勤不可」などの代表制約について、テスト日程での**自動チェック合格**
* 入力ファイル差替えで再現性のある結果が得られる（乱択を使う場合はシード固定）

---

